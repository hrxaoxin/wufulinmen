<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>æˆ‘çš„ç¦å¡ - é›†äº”ç¦æ´»åŠ¨</title>
    <link rel="icon" href="images/fu-cards/wufulinmen.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f5f5f5;
            background-image: linear-gradient(135deg, #f5f5f5 0%, #e8f5e8 100%);
            overflow-x: hidden;
        }
        
        /* ç²’å­èƒŒæ™¯å®¹å™¨ */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }
        
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .collection-card {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .collection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background-color: #ff6b6b;
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #ee5a6f;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: white;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
        }
        
        .collection-summary {
            background: linear-gradient(135deg, #4ecdc4 0%, #45b7aa 100%);
            border-radius: 16px;
            color: white;
        }
        
        .fu-card-item {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .fu-card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <!-- ç²’å­èƒŒæ™¯ -->
    <div id="particles-js"></div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar fixed bottom-0 left-0 right-0 z-10">
        <div class="flex justify-around items-center py-2 px-4">
            <a href="index.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 hover:bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸ &nbsp;</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">é¦–é¡µ</span>
            </a>
            <a href="mint.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 hover:bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸƒ</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">é“¸é€ </span>
            </a>
            <a href="collection.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸ</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">ç¦å¡</span>
            </a>
            <a href="rewards.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 hover:bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸ†</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">å¥–åŠ±</span>
            </a>
            <a href="trading.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 hover:bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸ’°</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">äº¤æ˜“</span>
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container mx-auto px-4 pt-6 pb-24">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="flex items-center mb-4">
            <div class="w-12 h-12 rounded-full bg-red-500 flex items-center justify-center mr-3">
                <span class="text-white text-2xl font-bold">ç¦</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">æˆ‘çš„ç¦å¡</h1>
        </div>

        <!-- æ”¶é›†è¯´æ˜ -->
        <p class="text-lg text-gray-600 mb-8">æ”¶é›†äº”ç¦ï¼Œåˆæˆäº”ç¦ä¸´é—¨</p>

        <!-- é’±åŒ…åŒºåŸŸæ¡† -->
        <div class="bg-white rounded-xl p-6 shadow-md mb-8">
            <!-- é’±åŒ…ä¿¡æ¯ -->
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                    <i class="text-blue-500 text-xl">ğŸ‘›</i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-800">é’±åŒ…ä¿¡æ¯</h3>
                    <p class="text-sm text-gray-500" id="walletAddress">æœªè¿æ¥é’±åŒ…</p>
                    <p class="text-xs text-gray-400" id="connectionStatus">è¯·ç‚¹å‡»è¿æ¥é’±åŒ…æŒ‰é’®</p>
                </div>
                <div class="flex space-x-2">
                    <button class="btn-primary text-sm" id="connectWalletBtn">
                        <i class="fas fa-plug mr-1"></i> è¿æ¥
                    </button>
                    <button class="btn-secondary text-sm" id="refreshWallet">
                        <i class="fas fa-sync-alt mr-1"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¦å¡åŒºåŸŸæ¡† -->
        <div class="bg-white rounded-xl p-6 shadow-md mb-8">
            <!-- æ”¶é›†è¿›åº¦ -->
            <div class="flex items-center mb-6">
                <div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center mr-3">
                    <i class="text-white text-sm">ğŸ“Š</i>
                </div>
                <h2 class="text-lg font-semibold text-gray-800">æ”¶é›†è¿›åº¦</h2>
            </div>

            <!-- ç¦å¡ç½‘æ ¼ -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <!-- çˆ±å›½ç¦ -->
                <div class="bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg p-4 flex flex-col items-center">
                    <div class="w-24 h-24 mb-2">
                        <img src="images/fu-cards/aiguo.png" alt="çˆ±å›½ç¦" class="w-full h-full object-contain">
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">çˆ±å›½ç¦</h3>
                    <p class="text-sm font-medium text-gray-700">x0</p>
                </div>

                <!-- å¯Œå¼ºç¦ -->
                <div class="bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg p-4 flex flex-col items-center">
                    <div class="w-24 h-24 mb-2">
                        <img src="images/fu-cards/fuqiang.png" alt="å¯Œå¼ºç¦" class="w-full h-full object-contain">
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">å¯Œå¼ºç¦</h3>
                    <p class="text-sm font-medium text-gray-700">x0</p>
                </div>

                <!-- å’Œè°ç¦ -->
                <div class="bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg p-4 flex flex-col items-center">
                    <div class="w-24 h-24 mb-2">
                        <img src="images/fu-cards/hexie.png" alt="å’Œè°ç¦" class="w-full h-full object-contain">
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">å’Œè°ç¦</h3>
                    <p class="text-sm font-medium text-gray-700">x0</p>
                </div>

                <!-- å‹å–„ç¦ -->
                <div class="bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg p-4 flex flex-col items-center">
                    <div class="w-24 h-24 mb-2">
                        <img src="images/fu-cards/youshan.png" alt="å‹å–„ç¦" class="w-full h-full object-contain">
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">å‹å–„ç¦</h3>
                    <p class="text-sm font-medium text-gray-700">x0</p>
                </div>

                <!-- æ•¬ä¸šç¦ -->
                <div class="bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg p-4 flex flex-col items-center">
                    <div class="w-24 h-24 mb-2">
                        <img src="images/fu-cards/jingye.png" alt="æ•¬ä¸šç¦" class="w-full h-full object-contain">
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">æ•¬ä¸šç¦</h3>
                    <p class="text-sm font-medium text-gray-700">x0</p>
                </div>

                <!-- ä¸‡èƒ½ç¦ -->
                <div class="bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg p-4 flex flex-col items-center">
                    <div class="w-24 h-24 mb-2">
                        <img src="images/fu-cards/wanneng.png" alt="ä¸‡èƒ½ç¦" class="w-full h-full object-contain">
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">ä¸‡èƒ½ç¦</h3>
                    <p class="text-sm font-medium text-gray-700">x0</p>
                </div>
            </div>

            <!-- åˆæˆæŒ‰é’® -->
            <div class="flex justify-center mt-6">
                <button id="synthesizeBtn" class="btn-primary px-8 py-3 text-lg font-semibold">
                    åˆæˆäº”ç¦ä¸´é—¨
                </button>
            </div>
        </div>

        <!-- äº”ç¦ä¸´é—¨åŒºåŸŸ -->
        <div class="bg-white rounded-xl p-6 shadow-md mb-8" id="wufuLinMenSection">
            <!-- äº”ç¦ä¸´é—¨æ ‡é¢˜ -->
            <div class="flex items-center mb-6">
                <div class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center mr-3">
                    <span class="text-white text-sm font-bold">ç¦</span>
                </div>
                <h2 class="text-lg font-semibold text-gray-800">æˆ‘çš„äº”ç¦ä¸´é—¨</h2>
            </div>

            <!-- äº”ç¦ä¸´é—¨ç¦å¡ -->
            <div id="wufuLinMenCard" class="hidden">
                <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-xl p-6 text-center">
                    <div class="w-32 h-32 mb-4 mx-auto">
                        <img src="images/fu-cards/wufulinmen.png" alt="äº”ç¦ä¸´é—¨" class="w-full h-full object-contain">
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">äº”ç¦ä¸´é—¨</h3>
                    <p class="text-white/90">äº”ç¦é½èšï¼Œå¥½è¿è¿è¿</p>
                </div>
            </div>

            <!-- æœªåˆæˆæç¤º -->
            <div id="noWuFuLinMen" class="text-center py-12">
                <div class="w-24 h-24 mb-4 mx-auto rounded-full bg-gray-100 flex items-center justify-center">
                    <i class="text-gray-400 text-4xl">ğŸ¯</i>
                </div>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">å°šæœªåˆæˆäº”ç¦ä¸´é—¨</h3>
                <p class="text-gray-500">é›†é½äº”ç§ç¦å¡ï¼Œåˆæˆäº”ç¦ä¸´é—¨ï¼Œè·å¾—é¢å¤–åˆ†çº¢</p>
            </div>
        </div>

        <!-- æˆ‘çš„ç¦å¡åŒºåŸŸæ¡† -->
        <div class="bg-white rounded-xl p-6 shadow-md mb-8">
            <!-- ç¦å¡æ ‡é¢˜ -->
            <div class="flex items-center mb-6">
                <div class="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center mr-3">
                    <span class="text-white text-sm font-bold">ç¦</span>
                </div>
                <h2 class="text-lg font-semibold text-gray-800" id="fukaCountTitle">æˆ‘çš„ç¦å¡ (0)</h2>
            </div>

            <!-- ç¦å¡åˆ—è¡¨ -->
            <div class="space-y-4" id="fukaList">
                <!-- ç¦å¡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
    <script src="abis.js"></script>
    <script>
        // ç²’å­èƒŒæ™¯æ•ˆæœ
        particlesJS('particles-js', {
            particles: {
                number: {
                    value: 80,
                    density: {
                        enable: true,
                        value_area: 800
                    }
                },
                color: {
                    value: '#ff6b6b'
                },
                shape: {
                    type: 'circle',
                    stroke: {
                        width: 0,
                        color: '#000000'
                    }
                },
                opacity: {
                    value: 0.5,
                    random: true,
                    anim: {
                        enable: true,
                        speed: 1,
                        opacity_min: 0.1,
                        sync: false
                    }
                },
                size: {
                    value: 5,
                    random: true,
                    anim: {
                        enable: true,
                        speed: 2,
                        size_min: 0.1,
                        sync: false
                    }
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#ff6b6b',
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 1,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false,
                    attract: {
                        enable: false,
                        rotateX: 600,
                        rotateY: 1200
                    }
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: {
                        enable: true,
                        mode: 'grab'
                    },
                    onclick: {
                        enable: true,
                        mode: 'push'
                    },
                    resize: true
                },
                modes: {
                    grab: {
                        distance: 140,
                        line_linked: {
                            opacity: 1
                        }
                    },
                    push: {
                        particles_nb: 4
                    }
                }
            },
            retina_detect: true
        });
        // æ™ºèƒ½åˆçº¦ABIï¼ˆä»abis.jsæ–‡ä»¶åŠ è½½ï¼‰
        // rewardManagerABIã€tokenBurnerABIã€fiveBlessingsNFTABI å·²åœ¨ abis.js ä¸­å®šä¹‰ä¸ºå…¨å±€å˜é‡

        // ä»abis.jsä¸­åŠ è½½åˆçº¦åœ°å€
        const rewardManagerAddress = window.contractAddresses.rewardManager;
        const tokenBurnerAddress = window.contractAddresses.tokenBurner;
        const fiveBlessingsNFTAddress = window.contractAddresses.fiveBlessingsNFT;

        // å…¨å±€å˜é‡
        let web3 = null;
        let rewardManagerContract = null;
        let tokenBurnerContract = null;
        let fiveBlessingsNFTContract = null;
        let accounts = [];

        // DOMå…ƒç´ 
        let fukaList;
        let synthesizeBtn;
        let wufuLinMenCard;
        let noWuFuLinMen;
        let walletAddress;
        let connectionStatus;
        let connectWalletBtn;
        let refreshWallet;

        // ç¦å¡æè¿°
        const FUKA_DESCRIPTIONS = {
            'å’Œè°ç¦': 'å’Œç¦ç›¸å¤„ï¼Œå¹¸ç¦ç¾æ»¡',
            'å‹å–„ç¦': 'å‹å–„å¾…äººï¼Œç¦æŠ¥å¸¸åœ¨',
            'å¯Œå¼ºç¦': 'å›½å¯Œæ°‘å¼ºï¼Œç¹è£æ˜Œç››',
            'çˆ±å›½ç¦': 'çˆ±æˆ‘ä¸­åï¼Œç¦æ³½ç»µé•¿',
            'æ•¬ä¸šç¦': 'æ•¬ä¸šä¹ä¸šï¼Œç¦ç¦„å®‰åº·',
            'ä¸‡èƒ½ç¦': 'ä¸‡ç¦é½èšï¼Œå¥½è¿ä¸´é—¨',
            'äº”ç¦ä¸´é—¨': 'äº”ç¦é½èšï¼Œå¥½è¿è¿è¿'
        };

        // ç¦å¡ç±»å‹æšä¸¾
        const BlessingType = {
            AiGuo: 0,      // çˆ±å›½ç¦
            FuQiang: 1,    // å¯Œå¼ºç¦
            HeXie: 2,      // å’Œè°ç¦
            YouShan: 3,    // å‹å–„ç¦
            JingYe: 4,     // æ•¬ä¸šç¦
            WanNeng: 5,    // ä¸‡èƒ½ç¦
            WuFuLinMen: 6  // äº”ç¦ä¸´é—¨
        };

        // åˆå§‹åŒ–
        console.log('collection.html: å¼€å§‹æ‰§è¡ŒJavaScriptä»£ç ');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('collection.html: DOMContentLoadedäº‹ä»¶è§¦å‘');
            // è·å–DOMå…ƒç´ 
            fukaList = document.getElementById('fukaList');
            synthesizeBtn = document.getElementById('synthesizeBtn');
            wufuLinMenCard = document.getElementById('wufuLinMenCard');
            noWuFuLinMen = document.getElementById('noWuFuLinMen');
            walletAddress = document.getElementById('walletAddress');
            connectionStatus = document.getElementById('connectionStatus');
            connectWalletBtn = document.getElementById('connectWalletBtn');
            refreshWallet = document.getElementById('refreshWallet');
            
            console.log('collection.html: DOMå…ƒç´ è·å–ç»“æœ:', {
                fukaList: !!fukaList,
                synthesizeBtn: !!synthesizeBtn,
                wufuLinMenCard: !!wufuLinMenCard,
                noWuFuLinMen: !!noWuFuLinMen,
                walletAddress: !!walletAddress,
                connectionStatus: !!connectionStatus,
                connectWalletBtn: !!connectWalletBtn,
                refreshWallet: !!refreshWallet
            });
            
            // åˆå§‹è¿æ¥é’±åŒ…
            connectWallet();

            // åˆæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            synthesizeBtn.addEventListener('click', async function() {
                await synthesizeWuFuLinMen();
            });

            // è¿æ¥é’±åŒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            connectWalletBtn.addEventListener('click', function() {
                connectWallet();
            });

            // åˆ·æ–°é’±åŒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            refreshWallet.addEventListener('click', function() {
                connectWallet();
            });

            // ç›‘å¬é’±åŒ…è´¦æˆ·å˜åŒ–
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.on('accountsChanged', function(accounts) {
                    console.log('é’±åŒ…è´¦æˆ·å˜åŒ–:', accounts);
                    if (accounts.length > 0) {
                        // é’±åŒ…å·²è¿æ¥ï¼Œæ›´æ–°çŠ¶æ€
                        console.log('è´¦æˆ·å·²æ›´æ–°ï¼Œé‡æ–°è¿æ¥é’±åŒ…...');
                        connectWallet();
                    } else {
                        // é’±åŒ…å·²æ–­å¼€è¿æ¥
                        console.log('é’±åŒ…å·²æ–­å¼€è¿æ¥');
                        // é‡ç½®çŠ¶æ€
                        web3 = null;
                        rewardManagerContract = null;
                        tokenBurnerContract = null;
                        fiveBlessingsNFTContract = null;
                        accounts = [];
                        walletAddress.textContent = 'æœªè¿æ¥é’±åŒ…';
                        connectionStatus.textContent = 'é’±åŒ…å·²æ–­å¼€è¿æ¥';
                        connectionStatus.style.color = '#f44336';
                        connectWalletBtn.textContent = 'è¿æ¥';
                        connectWalletBtn.disabled = false;
                    }
                });

                // ç›‘å¬ç½‘ç»œå˜åŒ–
                window.ethereum.on('chainChanged', function(chainId) {
                    console.log('ç½‘ç»œå·²åˆ‡æ¢:', chainId);
                    // ç½‘ç»œåˆ‡æ¢åé‡æ–°è¿æ¥é’±åŒ…
                    console.log('ç½‘ç»œå·²åˆ‡æ¢ï¼Œé‡æ–°è¿æ¥é’±åŒ…...');
                    connectWallet();
                });
            }
        });

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            console.log('å¼€å§‹è¿æ¥é’±åŒ…...');
            
            // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
            connectionStatus.textContent = 'æ­£åœ¨è¿æ¥é’±åŒ…...';
            connectionStatus.style.color = '#ff9800';
            connectWalletBtn.textContent = 'è¿æ¥ä¸­...';
            connectWalletBtn.disabled = true;
            
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                try {
                    // æ£€æµ‹ç½‘ç»œ
                    const chainId = await web3.eth.getChainId();
                    console.log('å½“å‰ç½‘ç»œ:', chainId);
                    
                    // æ£€æŸ¥è´¦æˆ·
                    accounts = await web3.eth.requestAccounts();
                    console.log('è·å–åˆ°è´¦æˆ·:', accounts);
                    const address = accounts[0];
                    const shortAddress = address.substring(0, 4) + '...' + address.substring(address.length - 4);
                    walletAddress.textContent = shortAddress;
                    
                    // æ£€æŸ¥åˆçº¦åœ°å€æ˜¯å¦ä¸ºå ä½ç¬¦
                    if (rewardManagerAddress !== '0xPLACEHOLDER' && tokenBurnerAddress !== '0xPLACEHOLDER' && fiveBlessingsNFTAddress !== '0xPLACEHOLDER') {
                        // åˆå§‹åŒ–åˆçº¦
                        rewardManagerContract = new web3.eth.Contract(window.rewardManagerABI, rewardManagerAddress);
                        tokenBurnerContract = new web3.eth.Contract(window.tokenBurnerABI, tokenBurnerAddress);
                        fiveBlessingsNFTContract = new web3.eth.Contract(window.fiveBlessingsNFTABI, fiveBlessingsNFTAddress);
                        console.log('æ‰€æœ‰åˆçº¦åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.log('éƒ¨åˆ†åˆçº¦åœ°å€ä¸ºå ä½ç¬¦ï¼Œä»…è¿æ¥é’±åŒ…');
                        connectionStatus.textContent = 'é’±åŒ…å·²è¿æ¥ï¼Œä½†éƒ¨åˆ†åˆçº¦åœ°å€æœªé…ç½®';
                        connectionStatus.style.color = '#ff9800';
                    }
                    
                    // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
                    if (connectionStatus.textContent !== 'é’±åŒ…å·²è¿æ¥ï¼Œä½†éƒ¨åˆ†åˆçº¦åœ°å€æœªé…ç½®') {
                        connectionStatus.textContent = 'é’±åŒ…å·²è¿æ¥';
                        connectionStatus.style.color = '#4CAF50';
                    }
                    connectWalletBtn.textContent = 'å·²è¿æ¥';
                    connectWalletBtn.disabled = true;
                    
                    console.log('é’±åŒ…è¿æ¥æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°');
                    
                    // åŠ è½½æ•°æ®
                    loadFukaCounts();
                    loadFukaList();
                    checkWuFuLinMenStatus();
                } catch (error) {
                    console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                    // é‡ç½®çŠ¶æ€
                    web3 = null;
                    rewardManagerContract = null;
                    tokenBurnerContract = null;
                    fiveBlessingsNFTContract = null;
                    accounts = [];
                    walletAddress.textContent = 'æœªè¿æ¥é’±åŒ…';
                    
                    // åˆ†æé”™è¯¯åŸå› 
                    let errorMessage = 'è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                    if (error.code === 4001) {
                        errorMessage = 'ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚';
                    } else if (error.message && error.message.includes('chainId')) {
                        errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
                    } else if (error.message && error.message.includes('contract')) {
                        errorMessage = 'åˆçº¦è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆçº¦åœ°å€';
                    }
                    
                    connectionStatus.textContent = errorMessage;
                    connectionStatus.style.color = '#f44336';
                    connectWalletBtn.textContent = 'è¿æ¥';
                    connectWalletBtn.disabled = false;
                }
            } else {
                alert('è¯·å®‰è£…MetaMaskç­‰Web3é’±åŒ…æ’ä»¶');
                // é‡ç½®çŠ¶æ€
                web3 = null;
                rewardManagerContract = null;
                tokenBurnerContract = null;
                fiveBlessingsNFTContract = null;
                accounts = [];
                walletAddress.textContent = 'æœªè¿æ¥é’±åŒ…';
                connectionStatus.textContent = 'è¯·å®‰è£…Web3é’±åŒ…æ’ä»¶';
                connectionStatus.style.color = '#f44336';
                connectWalletBtn.textContent = 'è¿æ¥';
                connectWalletBtn.disabled = false;
            }
        }

        // åŠ è½½ç¦å¡æ•°é‡
        async function loadFukaCounts() {
            try {
                if (!rewardManagerContract || !accounts || accounts.length === 0) {
                    return;
                }
                
                const account = accounts[0];
                
                // ä½¿ç”¨RewardManagerçš„cardCountå‡½æ•°è·å–æ¯ç§ç¦å¡çš„æ•°é‡
                const aiGuoCount = await rewardManagerContract.methods.cardCount(account, 0).call();
                const fuQiangCount = await rewardManagerContract.methods.cardCount(account, 1).call();
                const heXieCount = await rewardManagerContract.methods.cardCount(account, 2).call();
                const youShanCount = await rewardManagerContract.methods.cardCount(account, 3).call();
                const jingYeCount = await rewardManagerContract.methods.cardCount(account, 4).call();
                const wanNengCount = await rewardManagerContract.methods.cardCount(account, 5).call();
                
                console.log('RewardManageræ˜¾ç¤ºçš„å„ç§ç¦å¡æ•°é‡:', {
                    aiGuoCount,
                    fuQiangCount,
                    heXieCount,
                    youShanCount,
                    jingYeCount,
                    wanNengCount
                });
                
                // è®¡ç®—RewardManagerä¸­çš„æ€»ç¦å¡æ•°é‡
                const totalFromRewardManager = parseInt(aiGuoCount) + parseInt(fuQiangCount) + parseInt(heXieCount) + parseInt(youShanCount) + parseInt(jingYeCount) + parseInt(wanNengCount);
                console.log('RewardManagerè®¡ç®—çš„æ€»ç¦å¡æ•°é‡:', totalFromRewardManager);
                
                // æ›´æ–°ç¦å¡æ•°é‡
                updateFukaCount('çˆ±å›½ç¦', aiGuoCount);
                updateFukaCount('å¯Œå¼ºç¦', fuQiangCount);
                updateFukaCount('å’Œè°ç¦', heXieCount);
                updateFukaCount('å‹å–„ç¦', youShanCount);
                updateFukaCount('æ•¬ä¸šç¦', jingYeCount);
                updateFukaCount('ä¸‡èƒ½ç¦', wanNengCount);
            } catch (error) {
                console.error('è·å–ç¦å¡æ•°é‡å¤±è´¥:', error);
                // é»˜è®¤æ˜¾ç¤º0
                updateFukaCount('çˆ±å›½ç¦', 0);
                updateFukaCount('å¯Œå¼ºç¦', 0);
                updateFukaCount('å’Œè°ç¦', 0);
                updateFukaCount('å‹å–„ç¦', 0);
                updateFukaCount('æ•¬ä¸šç¦', 0);
                updateFukaCount('ä¸‡èƒ½ç¦', 0);
            }
        }

        // æ›´æ–°å•ä¸ªç¦å¡æ•°é‡
        function updateFukaCount(fukaName, count) {
            const fukaElements = document.querySelectorAll('.bg-gradient-to-br.from-orange-100.to-orange-200');
            fukaElements.forEach(element => {
                const h3 = element.querySelector('h3');
                if (h3 && h3.textContent === fukaName) {
                    const countElement = element.querySelector('p');
                    if (countElement) {
                        countElement.textContent = `x${count}`;
                    }
                }
            });
        }

        // åŠ è½½ç¦å¡åˆ—è¡¨
        async function loadFukaList() {
            try {
                if (!rewardManagerContract || !accounts || accounts.length === 0) {
                    return;
                }
                
                const account = accounts[0];
                
                // æ¸…ç©ºåˆ—è¡¨
                fukaList.innerHTML = '';

                // ä½¿ç”¨RewardManagerçš„cardCountæ¥æ˜¾ç¤ºç¦å¡æ•°é‡
                const aiGuoCount = await rewardManagerContract.methods.cardCount(account, 0).call();
                const fuQiangCount = await rewardManagerContract.methods.cardCount(account, 1).call();
                const heXieCount = await rewardManagerContract.methods.cardCount(account, 2).call();
                const youShanCount = await rewardManagerContract.methods.cardCount(account, 3).call();
                const jingYeCount = await rewardManagerContract.methods.cardCount(account, 4).call();
                const wanNengCount = await rewardManagerContract.methods.cardCount(account, 5).call();
                
                console.log('RewardManageræ˜¾ç¤ºçš„ç¦å¡æ•°é‡:', {
                    aiGuoCount,
                    fuQiangCount,
                    heXieCount,
                    youShanCount,
                    jingYeCount,
                    wanNengCount
                });
                
                // åˆ›å»ºç¦å¡æ•°æ®æ•°ç»„
                const fukaData = [
                    { type: 0, name: 'çˆ±å›½ç¦', image: 'aiguo.png', count: aiGuoCount },
                    { type: 1, name: 'å¯Œå¼ºç¦', image: 'fuqiang.png', count: fuQiangCount },
                    { type: 2, name: 'å’Œè°ç¦', image: 'hexie.png', count: heXieCount },
                    { type: 3, name: 'å‹å–„ç¦', image: 'youshan.png', count: youShanCount },
                    { type: 4, name: 'æ•¬ä¸šç¦', image: 'jingye.png', count: jingYeCount },
                    { type: 5, name: 'ä¸‡èƒ½ç¦', image: 'wanneng.png', count: wanNengCount }
                ];
                
                // è®¡ç®—æ€»ç¦å¡æ•°é‡
                let totalCount = 0;
                let hasFuka = false;
                fukaData.forEach(fuka => {
                    const count = parseInt(fuka.count);
                    totalCount += count;
                    console.log('å¤„ç†ç¦å¡ç±»å‹:', fuka.name, 'æ•°é‡:', count, 'ç´¯è®¡æ€»æ•°:', totalCount);
                    if (count > 0) {
                        hasFuka = true;
                        for (let i = 0; i < count; i++) {
                            const fukaCard = document.createElement('div');
                            fukaCard.className = 'border-2 border-orange-400 bg-orange-50 rounded-lg p-4 text-center';
                            fukaCard.innerHTML = `
                                <div class="w-24 h-24 mb-3 mx-auto">
                                    <img src="images/fu-cards/${fuka.image}" alt="${fuka.name}" class="w-full h-full object-contain">
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">${fuka.name}</h3>
                                <p class="text-gray-600">${FUKA_DESCRIPTIONS[fuka.name]}</p>
                            `;
                            fukaList.appendChild(fukaCard);
                        }
                    }
                });
                console.log('RewardManagerè®¡ç®—çš„æ€»ç¦å¡æ•°é‡:', totalCount);

                // å¦‚æœæ²¡æœ‰ç¦å¡ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                if (!hasFuka) {
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'border-2 border-gray-300 bg-gray-50 rounded-lg p-4 text-center';
                    emptyCard.innerHTML = `
                        <div class="w-16 h-16 mb-3 mx-auto">
                            <i class="fas fa-gift text-gray-400 text-4xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">æš‚æ— ç¦å¡</h3>
                        <p class="text-gray-600">æ‚¨å½“å‰æ²¡æœ‰æŒæœ‰ä»»ä½•ç¦å¡</p>
                        <p class="text-gray-500 text-sm mt-2">å‰å¾€é“¸é€ é¡µé¢è·å–ç¦å¡å§ï¼</p>
                        <div class="mt-4">
                            <a href="mint.html" class="btn-primary inline-block">
                                å»é“¸é€ 
                            </a>
                        </div>
                    `;
                    fukaList.appendChild(emptyCard);
                }

                // æ›´æ–°æ ‡é¢˜ä¸­çš„æ•°é‡ï¼Œä½¿ç”¨RewardManagerè®¡ç®—çš„æ€»æ•°é‡
                const title = document.getElementById('fukaCountTitle');
                if (title) {
                    title.textContent = `æˆ‘çš„ç¦å¡ (${totalCount})`;
                    console.log('æ›´æ–°æ ‡é¢˜ä¸­çš„ç¦å¡æ•°é‡:', totalCount);
                }
            } catch (error) {
                console.error('è·å–ç¦å¡åˆ—è¡¨å¤±è´¥:', error);
                // æ¸…ç©ºåˆ—è¡¨
                fukaList.innerHTML = '';
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorCard = document.createElement('div');
                errorCard.className = 'border-2 border-red-300 bg-red-50 rounded-lg p-4 text-center';
                errorCard.innerHTML = `
                    <div class="w-16 h-16 mb-3 mx-auto">
                        <i class="fas fa-exclamation-circle text-red-500 text-4xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">åŠ è½½å¤±è´¥</h3>
                    <p class="text-gray-600">è·å–ç¦å¡åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯</p>
                    <p class="text-gray-500 text-sm mt-2">è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                `;
                fukaList.appendChild(errorCard);
                // æ›´æ–°æ ‡é¢˜
                const title = document.getElementById('fukaCountTitle');
                if (title) {
                    title.textContent = `æˆ‘çš„ç¦å¡ (0)`;
                }
            }
        }

        // æ£€æŸ¥äº”ç¦ä¸´é—¨çŠ¶æ€
        async function checkWuFuLinMenStatus() {
            try {
                if (!rewardManagerContract || !accounts || accounts.length === 0) {
                    return;
                }
                
                const account = accounts[0];
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æŒæœ‰äº”ç¦ä¸´é—¨
                const hasWuFuLinMen = await rewardManagerContract.methods.isWuFuHolder(account).call();
                
                if (hasWuFuLinMen) {
                    // æ˜¾ç¤ºäº”ç¦ä¸´é—¨ç¦å¡
                    wufuLinMenCard.classList.remove('hidden');
                    noWuFuLinMen.classList.add('hidden');
                } else {
                    // æ˜¾ç¤ºæœªåˆæˆæç¤º
                    wufuLinMenCard.classList.add('hidden');
                    noWuFuLinMen.classList.remove('hidden');
                }
            } catch (error) {
                console.error('æ£€æŸ¥äº”ç¦ä¸´é—¨çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åˆæˆäº”ç¦ä¸´é—¨
        async function synthesizeWuFuLinMen() {
            try {
                // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
                if (!fiveBlessingsNFTContract || !accounts || accounts.length === 0) {
                    alert('è¯·å…ˆè¿æ¥é’±åŒ…åå†å°è¯•åˆæˆ');
                    return;
                }
                
                const account = accounts[0];
                // æ£€æŸ¥åˆçº¦æ˜¯å¦åˆå§‹åŒ–
                if (!fiveBlessingsNFTContract) {
                    alert('åˆçº¦æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥åˆçº¦åœ°å€é…ç½®');
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æŒæœ‰äº”ç¦ä¸´é—¨
                const hasWuFuLinMen = await rewardManagerContract.methods.isWuFuHolder(account).call();
                if (hasWuFuLinMen) {
                    alert('ğŸ‰ æ‚¨å·²ç»æŒæœ‰äº”ç¦ä¸´é—¨ï¼Œæ— éœ€å†æ¬¡åˆæˆ\n\näº”ç¦ä¸´é—¨æ˜¯æœ€é«˜ç­‰çº§çš„ç¦å¡ï¼ŒæŒæœ‰å®ƒå¯ä»¥äº«å—é¢å¤–çš„ç¨æ”¶åˆ†çº¢');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦é›†é½äº”ç¦
                // ä½¿ç”¨RewardManagerçš„_hasAllBasicå‡½æ•°
                const hasAllBasic = await rewardManagerContract.methods._hasAllBasic(account).call();
                
                if (!hasAllBasic) {
                    // è·å–æ¯ç§ç¦å¡çš„æ•°é‡
                    const aiGuoCount = await rewardManagerContract.methods.cardCount(account, 0).call();
                    const fuQiangCount = await rewardManagerContract.methods.cardCount(account, 1).call();
                    const heXieCount = await rewardManagerContract.methods.cardCount(account, 2).call();
                    const youShanCount = await rewardManagerContract.methods.cardCount(account, 3).call();
                    const jingYeCount = await rewardManagerContract.methods.cardCount(account, 4).call();
                    const wanNengCount = await rewardManagerContract.methods.cardCount(account, 5).call();
                    
                    // æ„å»ºç¼ºå¤±çš„ç¦å¡åˆ—è¡¨
                    const missingCards = [];
                    if (parseInt(aiGuoCount) === 0) missingCards.push('çˆ±å›½ç¦');
                    if (parseInt(fuQiangCount) === 0) missingCards.push('å¯Œå¼ºç¦');
                    if (parseInt(heXieCount) === 0) missingCards.push('å’Œè°ç¦');
                    if (parseInt(youShanCount) === 0) missingCards.push('å‹å–„ç¦');
                    if (parseInt(jingYeCount) === 0) missingCards.push('æ•¬ä¸šç¦');
                    
                    if (parseInt(wanNengCount) > 0) {
                        alert(`ğŸ“‹ æ‚¨å¯ä»¥ä½¿ç”¨ä¸‡èƒ½ç¦æ¥æ›¿ä»£ç¼ºå¤±çš„ç¦å¡\n\næ‚¨å½“å‰æ‹¥æœ‰ ${wanNengCount} å¼ ä¸‡èƒ½ç¦\n\nè¯·ç¡®ä¿æ‚¨æœ‰è¶³å¤Ÿçš„ä¸‡èƒ½ç¦æ¥æ›¿ä»£ç¼ºå¤±çš„ç¦å¡åå†å°è¯•åˆæˆï¼`);
                    } else {
                        alert(`ğŸ“‹ æ‚¨è¿˜æœªé›†é½äº”ç¦ï¼Œè¯·ç»§ç»­æ”¶é›†ä»¥ä¸‹ç¦å¡ï¼š\n\n${missingCards.join('\n')}\n\né›†é½åå³å¯åˆæˆäº”ç¦ä¸´é—¨ï¼Œäº«å—é¢å¤–åˆ†çº¢ï¼`);
                    }
                    return;
                }
                
                // ç¡®è®¤åˆæˆ
                if (!confirm('ğŸ¯ åˆæˆäº”ç¦ä¸´é—¨\n\nåˆæˆåï¼Œæ‚¨å°†è·å¾—ï¼š\nâ€¢ ä¸€å¼ äº”ç¦ä¸´é—¨ç¨€æœ‰ç¦å¡\nâ€¢ é¢å¤–1%çš„ç¨æ”¶åˆ†çº¢èµ„æ ¼\nâ€¢ æ›´é«˜çš„æ”¶è—ä»·å€¼\n\næ³¨æ„ï¼šç”¨äºåˆæˆçš„5å¼ åŸºç¡€ç¦å¡å°†è¢«æ°¸ä¹…é”€æ¯\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    return;
                }
                
                // æ˜¾ç¤ºåˆæˆä¸­çŠ¶æ€
                synthesizeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> åˆæˆä¸­...';
                synthesizeBtn.disabled = true;
                
                try {
                    // è°ƒç”¨åˆæˆäº”ç¦ä¸´é—¨çš„åŠŸèƒ½
                    await fiveBlessingsNFTContract.methods.synthesizeWuFu().send({ from: account });
                    
                    // åˆæˆæˆåŠŸ
                    alert('ğŸ‰ åˆæˆæˆåŠŸï¼\n\næ­å–œæ‚¨è·å¾—äº†äº”ç¦ä¸´é—¨ç¨€æœ‰ç¦å¡ï¼\n\nâœ… ç”¨äºåˆæˆçš„5å¼ åŸºç¡€ç¦å¡å·²è¢«é”€æ¯\nâœ… æ‚¨ç°åœ¨æ‹¥æœ‰é¢å¤–1%çš„ç¨æ”¶åˆ†çº¢èµ„æ ¼\nâœ… äº”ç¦ä¸´é—¨å°†ä¸ºæ‚¨å¸¦æ¥æ›´å¤šå¥½è¿\n\nå¿«å»é¢†å–é¡µé¢æŸ¥çœ‹æ‚¨çš„åˆ†çº¢å§ï¼');
                    
                    // æ›´æ–°é¡µé¢
                    await checkWuFuLinMenStatus();
                    await loadFukaCounts();
                    await loadFukaList();
                } catch (error) {
                    console.error('åˆæˆå¤±è´¥:', error);
                    
                    // åˆ†æé”™è¯¯åŸå› 
                    let errorMsg = 'åˆæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
                    if (error.code === 4001) {
                        errorMsg = 'æ‚¨å–æ¶ˆäº†äº¤æ˜“ï¼Œè¯·é‡è¯•';
                    } else if (error.message && error.message.includes('insufficient funds')) {
                        errorMsg = 'Gasè´¹ç”¨ä¸è¶³ï¼Œè¯·ç¡®ä¿é’±åŒ…ä¸­æœ‰è¶³å¤Ÿçš„BNBæ”¯ä»˜Gasè´¹ç”¨';
                    } else if (error.message && error.message.includes('reverted')) {
                        errorMsg = 'åˆçº¦æ‰§è¡Œå¤±è´¥ï¼š' + error.message;
                    }
                    
                    alert(`âŒ åˆæˆå¤±è´¥\n\n${errorMsg}\n\nè¯·æ£€æŸ¥ä»¥ä¸‹äº‹é¡¹ï¼š\n1. é’±åŒ…æ˜¯å¦æœ‰è¶³å¤Ÿçš„BNBæ”¯ä»˜Gasè´¹ç”¨\n2. ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š\n3. åˆçº¦åœ°å€æ˜¯å¦æ­£ç¡®é…ç½®\n4. æ‚¨æ˜¯å¦ç¡®å®æŒæœ‰5å¼ åŸºç¡€ç¦å¡æˆ–è¶³å¤Ÿçš„ä¸‡èƒ½ç¦`);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    synthesizeBtn.innerHTML = 'åˆæˆäº”ç¦ä¸´é—¨';
                    synthesizeBtn.disabled = false;
                }
            } catch (error) {
                console.error('åˆæˆäº”ç¦ä¸´é—¨å¤±è´¥:', error);
                alert('âŒ æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
                synthesizeBtn.innerHTML = 'åˆæˆäº”ç¦ä¸´é—¨';
                synthesizeBtn.disabled = false;
            }
        }
    </script>
</body>
</html>