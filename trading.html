<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NFTäº¤æ˜“å¸‚åœº - äº”ç¦ä¸´é—¨</title>
    <link rel="icon" href="images/fu-cards/wufulinmen.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
    <script src="abis.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f5f5f5;
            background-image: linear-gradient(135deg, #f5f5f5 0%, #e8f5e8 100%);
            overflow-x: hidden;
        }
        /* ç²’å­èƒŒæ™¯å®¹å™¨ */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .mint-card {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .mint-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background-color: #ff6b6b;
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #ee5a6f;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: white;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: 1px solid #dc3545;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        .input-field {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 107, 0.25);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <!-- ç²’å­èƒŒæ™¯ -->
    <div id="particles-js"></div>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar fixed bottom-0 left-0 right-0 z-10">
        <div class="flex justify-around items-center py-2 px-4">
            <a href="index.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 hover:bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸ &nbsp;</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">é¦–é¡µ</span>
            </a>
            <a href="mint.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 hover:bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸƒ</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">é“¸é€ </span>
            </a>
            <a href="collection.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 hover:bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸ</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">ç¦å¡</span>
            </a>
            <a href="rewards.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 hover:bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸ†</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">å¥–åŠ±</span>
            </a>
            <a href="trading.html" class="flex flex-col items-center justify-center w-full py-2 px-3 rounded-xl transition-all duration-300 bg-gray-100">
                <div class="text-2xl mb-1 transition-transform duration-300">ğŸ’°</div>
                <span class="text-xs font-bold transition-all duration-300 text-gray-700">äº¤æ˜“</span>
            </a>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="container mx-auto px-4 pt-6 pb-24">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="flex items-center mb-4">
            <div class="w-12 h-12 rounded-full bg-red-500 flex items-center justify-center mr-3">
                <span class="text-white text-2xl font-bold">ç¦</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">NFTäº¤æ˜“å¸‚åœº</h1>
        </div>
        <!-- é“¸é€ è¯´æ˜ -->
        <p class="text-lg text-gray-600 mb-8">ä¹°å–äº”ç¦ä¸´é—¨NFTï¼Œæ”¯æŒæ‰€æœ‰ç¥ç¦ç±»å‹</p>
        <!-- é’±åŒ…åŒºåŸŸæ¡† -->
        <div class="bg-white rounded-xl p-6 shadow-md mb-8">
            <!-- é’±åŒ…ä¿¡æ¯ -->
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                    <i class="text-blue-500 text-xl">ğŸ‘›</i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-800">é’±åŒ…ä¿¡æ¯</h3>
                    <p class="text-sm text-gray-500" id="walletAddress">æœªè¿æ¥é’±åŒ…</p>
                    <p class="text-xs text-gray-400" id="connectionStatus">è¯·ç‚¹å‡»è¿æ¥é’±åŒ…æŒ‰é’®</p>
                </div>
                <div class="flex space-x-2">
                    <button class="btn-primary text-sm" id="connectBtn">
                        <i class="fas fa-plug mr-1"></i> è¿æ¥
                    </button>
                    <button class="btn-secondary text-sm" id="refreshWallet">
                        <i class="fas fa-sync-alt mr-1"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
            <!-- ä»£å¸ä¿¡æ¯ -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">é’±åŒ…åœ°å€</span>
                    <span class="text-lg font-semibold text-gray-800" id="walletAddressDisplay">æœªè¿æ¥</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">ç½‘ç»œ</span>
                    <span class="text-lg font-semibold text-gray-800" id="networkName">æœªè¿æ¥</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">BNBä½™é¢</span>
                    <span class="text-lg font-semibold text-gray-800" id="balance">0</span>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½æ ‡ç­¾é¡µ -->
        <div class="bg-white rounded-xl p-4 shadow-md mb-8">
            <div class="flex border-b border-gray-200">
                <button id="browseTab" class="flex-1 py-3 font-medium text-center text-primary border-b-2 border-primary">æµè§ˆå¸‚åœº</button>
                <button id="listTab" class="flex-1 py-3 font-medium text-center text-gray-500 hover:text-primary">ä¸Šæ¶NFT</button>
                <button id="myListingsTab" class="flex-1 py-3 font-medium text-center text-gray-500 hover:text-primary">æˆ‘çš„ä¸Šæ¶</button>
            </div>
        </div>

        <!-- æµè§ˆå¸‚åœº -->
        <div id="browseSection" class="mb-12">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-dark">NFTå¸‚åœº</h2>
                <div class="flex space-x-4">
                    <select id="filterType" class="input-field w-48">
                        <option value="all">å…¨éƒ¨ç±»å‹</option>
                        <option value="0">çˆ±å›½</option>
                        <option value="1">å¯Œå¼º</option>
                        <option value="2">å’Œè°</option>
                        <option value="3">å‹å–„</option>
                        <option value="4">æ•¬ä¸š</option>
                        <option value="5">ä¸‡èƒ½</option>
                        <option value="6">äº”ç¦ä¸´é—¨</option>
                    </select>
                    <button id="refreshBtn" class="btn-secondary">
                        <i class="fa fa-refresh mr-2"></i>åˆ·æ–°
                    </button>
                </div>
            </div>
            
            <div id="marketplaceGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- NFTå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                <div class="col-span-full text-center py-12">
                    <i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i>
                    <p class="text-gray-600">åŠ è½½å¸‚åœºæ•°æ®ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ä¸Šæ¶NFT -->
        <div id="listSection" class="mb-12 hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-dark mb-6">ä¸Šæ¶NFT</h2>
                
                <form id="listForm" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">NFT ID</label>
                        <input type="number" id="tokenId" class="input-field" placeholder="è¾“å…¥è¦ä¸Šæ¶çš„NFT ID" required>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ä»·æ ¼ (BNB)</label>
                        <input type="number" id="listingPrice" step="0.0001" min="0.001" class="input-field" placeholder="è¾“å…¥ä¸Šæ¶ä»·æ ¼ (æœ€ä½0.001 BNB)" required>
                    </div>
                    
                    <div class="bg-light p-4 rounded-lg">
                        <p class="text-gray-700">
                            <i class="fa fa-info-circle text-primary mr-2"></i>
                            äº¤æ˜“æ‰‹ç»­è´¹ï¼š5%ï¼Œå°†è‡ªåŠ¨è½¬å…¥åˆ†çº¢é’±åŒ…
                        </p>
                    </div>
                    
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="checkTokenBtn" class="btn-secondary">
                            <i class="fa fa-search mr-2"></i>æ£€æŸ¥NFT
                        </button>
                        <button type="button" id="approveBtn" class="btn-secondary" disabled>
                            <i class="fas fa-key mr-1"></i> æˆæƒNFTç³»åˆ—
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fa fa-upload mr-2"></i>ä¸Šæ¶NFT
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æˆ‘çš„ä¸Šæ¶ -->
        <div id="myListingsSection" class="mb-12 hidden">
            <h2 class="text-2xl font-bold text-dark mb-6">æˆ‘çš„ä¸Šæ¶NFT</h2>
            
            <div id="myListingsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                <!-- æˆ‘çš„ä¸Šæ¶NFTå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                <div class="col-span-full text-center py-12">
                    <i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i>
                    <p class="text-gray-600">åŠ è½½æˆ‘çš„ä¸Šæ¶æ•°æ®ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- è´­ä¹°ç¡®è®¤æ¨¡æ€æ¡† -->
        <div id="buyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-dark">ç¡®è®¤è´­ä¹°</h3>
                    <button id="closeBuyModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <p class="text-gray-600">NFT ID: <span id="modalTokenId" class="font-bold"></span></p>
                    </div>
                    <div>
                        <p class="text-gray-600">ç±»å‹: <span id="modalTokenType" class="font-bold"></span></p>
                    </div>
                    <div>
                        <p class="text-gray-600">å–å®¶: <span id="modalSeller" class="font-mono text-sm"></span></p>
                    </div>
                    <div>
                        <p class="text-gray-600">ä»·æ ¼: <span id="modalPrice" class="font-bold text-primary"></span> BNB</p>
                    </div>
                    <div>
                        <p class="text-gray-600">æ‰‹ç»­è´¹: <span id="modalFee" class="font-bold text-primary"></span> BNB</p>
                    </div>
                    <div>
                        <p class="text-gray-600">æ€»ä»·: <span id="modalTotal" class="font-bold text-dark"></span> BNB</p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button id="cancelBuy" class="btn-secondary">å–æ¶ˆ</button>
                    <button id="confirmBuy" class="btn-primary">ç¡®è®¤è´­ä¹°</button>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message" class="fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg hidden"></div>
    </main>

    <!-- é¡µè„š -->
    <footer class="bg-dark text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fa fa-diamond text-accent text-xl"></i>
                        <span class="text-xl font-bold">äº”ç¦ä¸´é—¨ NFT</span>
                    </div>
                    <p class="text-gray-400">ä¼ ç»Ÿä¸­å›½ç¥ç¦æ–‡åŒ–ä¸åŒºå—é“¾æŠ€æœ¯çš„å®Œç¾ç»“åˆ</p>
                </div>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-github text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-twitter text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-telegram text-xl"></i>
                    </a>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-700 text-center text-gray-400">
                <p>&copy; 2024 äº”ç¦ä¸´é—¨ NFT. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</p>
            </div>
        </div>
    </footer>

    <script>
        // ç²’å­èƒŒæ™¯æ•ˆæœ
        particlesJS('particles-js', {
            particles: {
                number: {
                    value: 80,
                    density: {
                        enable: true,
                        value_area: 800
                    }
                },
                color: {
                    value: '#ff6b6b'
                },
                shape: {
                    type: 'circle',
                    stroke: {
                        width: 0,
                        color: '#000000'
                    }
                },
                opacity: {
                    value: 0.5,
                    random: true,
                    anim: {
                        enable: true,
                        speed: 1,
                        opacity_min: 0.1,
                        sync: false
                    }
                },
                size: {
                    value: 5,
                    random: true,
                    anim: {
                        enable: true,
                        speed: 2,
                        size_min: 0.1,
                        sync: false
                    }
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#ff6b6b',
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 1,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false,
                    attract: {
                        enable: false,
                        rotateX: 600,
                        rotateY: 1200
                    }
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: {
                        enable: true,
                        mode: 'grab'
                    },
                    onclick: {
                        enable: true,
                        mode: 'push'
                    },
                    resize: true
                },
                modes: {
                    grab: {
                        distance: 140,
                        line_linked: {
                            opacity: 1
                        }
                    },
                    push: {
                        particles_nb: 4
                    }
                }
            },
            retina_detect: true
        });

        // åˆçº¦ABIå’Œåœ°å€ï¼ˆä»abis.jså¼•å…¥ï¼‰
        const NFTTradingABI = window.NFTTradingABI;
        const NFTTradingAddress = window.NFTTradingAddress;
        const FiveBlessingsNFTABI = window.fiveBlessingsNFTABI;
        const FiveBlessingsNFTAddress = window.fiveBlessingsNFTAddress;

        // å…¨å±€å˜é‡
        let web3 = null;
        let accounts = [];
        let nftTradingContract = null;
        let fiveBlessingsNFTContract = null;
        let currentTokenIdToBuy;

        // ç¥ç¦ç±»å‹æ˜ å°„
        const blessingTypes = {
            0: 'çˆ±å›½',
            1: 'å¯Œå¼º',
            2: 'å’Œè°',
            3: 'å‹å–„',
            4: 'æ•¬ä¸š',
            5: 'ä¸‡èƒ½',
            6: 'äº”ç¦ä¸´é—¨'
        };

        // DOMå…ƒç´ 
        let walletAddress;
        let connectionStatus;
        let connectWalletBtn;
        let refreshWallet;
        let approveBtn;

        // åˆå§‹åŒ–
        console.log('trading.html: å¼€å§‹æ‰§è¡ŒJavaScriptä»£ç ');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('trading.html: DOMContentLoadedäº‹ä»¶è§¦å‘');
            // è·å–DOMå…ƒç´ 
            walletAddress = document.getElementById('walletAddress');
            connectionStatus = document.getElementById('connectionStatus');
            connectWalletBtn = document.getElementById('connectBtn');
            refreshWallet = document.getElementById('refreshWallet');
            
            approveBtn = document.getElementById('approveBtn');
            
            console.log('trading.html: DOMå…ƒç´ è·å–ç»“æœ:', {
                walletAddress: !!walletAddress,
                connectionStatus: !!connectionStatus,
                connectWalletBtn: !!connectWalletBtn,
                refreshWallet: !!refreshWallet,
                approveBtn: !!approveBtn
            });
            
            // åˆå§‹è¿æ¥é’±åŒ…
            connectWallet();

            // è¿æ¥é’±åŒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            connectWalletBtn.addEventListener('click', function() {
                connectWallet();
            });

            // åˆ·æ–°é’±åŒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            refreshWallet.addEventListener('click', function() {
                connectWallet();
            });
            
            // æˆæƒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            approveBtn.addEventListener('click', async function() {
                if (!accounts || accounts.length === 0) {
                    showMessage('è¯·è¿æ¥é’±åŒ…', 'error');
                    return;
                }
                
                const isApproved = await checkApprovalForAll();
                if (isApproved) {
                    showMessage('NFTç³»åˆ—å·²æˆæƒ', 'success');
                    return;
                }
                
                await approveForAll();
                // æ£€æŸ¥æˆæƒçŠ¶æ€å¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€
                await updateApprovalStatus();
            });

            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.getElementById('browseTab').addEventListener('click', () => {
                document.getElementById('browseSection').classList.remove('hidden');
                document.getElementById('listSection').classList.add('hidden');
                document.getElementById('myListingsSection').classList.add('hidden');
                
                document.getElementById('browseTab').classList.add('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('browseTab').classList.remove('text-gray-500');
                document.getElementById('listTab').classList.add('text-gray-500');
                document.getElementById('listTab').classList.remove('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('myListingsTab').classList.add('text-gray-500');
                document.getElementById('myListingsTab').classList.remove('text-primary', 'border-b-2', 'border-primary');
            });

            document.getElementById('listTab').addEventListener('click', () => {
                document.getElementById('browseSection').classList.add('hidden');
                document.getElementById('listSection').classList.remove('hidden');
                document.getElementById('myListingsSection').classList.add('hidden');
                
                document.getElementById('listTab').classList.add('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('listTab').classList.remove('text-gray-500');
                document.getElementById('browseTab').classList.add('text-gray-500');
                document.getElementById('browseTab').classList.remove('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('myListingsTab').classList.add('text-gray-500');
                document.getElementById('myListingsTab').classList.remove('text-primary', 'border-b-2', 'border-primary');
            });

            document.getElementById('myListingsTab').addEventListener('click', () => {
                document.getElementById('browseSection').classList.add('hidden');
                document.getElementById('listSection').classList.add('hidden');
                document.getElementById('myListingsSection').classList.remove('hidden');
                
                document.getElementById('myListingsTab').classList.add('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('myListingsTab').classList.remove('text-gray-500');
                document.getElementById('browseTab').classList.add('text-gray-500');
                document.getElementById('browseTab').classList.remove('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('listTab').classList.add('text-gray-500');
                document.getElementById('listTab').classList.remove('text-primary', 'border-b-2', 'border-primary');
                
                loadMyListings(1);
            });

            // åˆ·æ–°å¸‚åœºæŒ‰é’®
            document.getElementById('refreshBtn').addEventListener('click', () => loadMarketplace(1));

            // æ£€æŸ¥NFTæŒ‰é’®
            document.getElementById('checkTokenBtn').addEventListener('click', async () => {
                const tokenId = document.getElementById('tokenId').value;
                if (!tokenId) {
                    showMessage('è¯·è¾“å…¥NFT ID', 'error');
                    return;
                }
                await checkNFT(tokenId);
            });

            // ä¸Šæ¶è¡¨å•æäº¤
            document.getElementById('listForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const tokenId = document.getElementById('tokenId').value;
                const price = document.getElementById('listingPrice').value;
                
                if (!tokenId || !price) {
                    showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                    return;
                }
                
                const isValid = await checkNFT(parseInt(tokenId));
                if (isValid) {
                    await listNFT(parseInt(tokenId), price);
                }
            });

            // è´­ä¹°æ¨¡æ€æ¡†
            document.getElementById('closeBuyModal').addEventListener('click', () => {
                document.getElementById('buyModal').classList.add('hidden');
            });

            document.getElementById('cancelBuy').addEventListener('click', () => {
                document.getElementById('buyModal').classList.add('hidden');
            });

            document.getElementById('confirmBuy').addEventListener('click', () => {
                const priceText = document.getElementById('modalPrice').textContent;
                const price = priceText.replace(/[^\d.]/g, ''); // Remove non-numeric characters
                buyNFT(currentTokenIdToBuy, price);
            });

            // ç›‘å¬é’±åŒ…è´¦æˆ·å˜åŒ–
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.on('accountsChanged', function(accounts) {
                    console.log('é’±åŒ…è´¦æˆ·å˜åŒ–:', accounts);
                    if (accounts.length > 0) {
                        // é’±åŒ…å·²è¿æ¥ï¼Œæ›´æ–°çŠ¶æ€
                        console.log('è´¦æˆ·å·²æ›´æ–°ï¼Œé‡æ–°è¿æ¥é’±åŒ…...');
                        connectWallet();
                    } else {
                        // é’±åŒ…å·²æ–­å¼€è¿æ¥
                        console.log('é’±åŒ…å·²æ–­å¼€è¿æ¥');
                        // é‡ç½®çŠ¶æ€
                        web3 = null;
                        nftTradingContract = null;
                        fiveBlessingsNFTContract = null;
                        accounts = [];
                        walletAddress.textContent = 'æœªè¿æ¥é’±åŒ…';
                        connectionStatus.textContent = 'é’±åŒ…å·²æ–­å¼€è¿æ¥';
                        connectionStatus.style.color = '#f44336';
                        connectWalletBtn.textContent = 'è¿æ¥';
                        connectWalletBtn.disabled = false;
                    }
                });

                // ç›‘å¬ç½‘ç»œå˜åŒ–
                window.ethereum.on('chainChanged', function(chainId) {
                    console.log('ç½‘ç»œå·²åˆ‡æ¢:', chainId);
                    // ç½‘ç»œåˆ‡æ¢åé‡æ–°è¿æ¥é’±åŒ…
                    console.log('ç½‘ç»œå·²åˆ‡æ¢ï¼Œé‡æ–°è¿æ¥é’±åŒ…...');
                    connectWallet();
                });
            }
        });

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            console.log('å¼€å§‹è¿æ¥é’±åŒ…...');
            
            // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
            connectionStatus.textContent = 'æ­£åœ¨è¿æ¥é’±åŒ…...';
            connectionStatus.style.color = '#ff9800';
            connectWalletBtn.textContent = 'è¿æ¥ä¸­...';
            connectWalletBtn.disabled = true;
            
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                try {
                    // æ£€æµ‹ç½‘ç»œ
                    const chainId = await web3.eth.getChainId();
                    console.log('å½“å‰ç½‘ç»œ:', chainId);
                    
                    // æ£€æŸ¥è´¦æˆ·
                    accounts = await web3.eth.requestAccounts();
                    console.log('è·å–åˆ°è´¦æˆ·:', accounts);
                    const address = accounts[0];
                    const shortAddress = address.substring(0, 4) + '...' + address.substring(address.length - 4);
                    walletAddress.textContent = shortAddress;
                    
                    // åˆå§‹åŒ–åˆçº¦
                    try {
                        nftTradingContract = new web3.eth.Contract(NFTTradingABI, NFTTradingAddress);
                        fiveBlessingsNFTContract = new web3.eth.Contract(FiveBlessingsNFTABI, FiveBlessingsNFTAddress);
                        console.log('åˆçº¦åˆå§‹åŒ–å®Œæˆ');
                    } catch (error) {
                        connectionStatus.textContent = 'é’±åŒ…å·²è¿æ¥ï¼Œä½†éƒ¨åˆ†åˆçº¦åˆå§‹åŒ–å¤±è´¥';
                        connectionStatus.style.color = '#ff9800';
                    }
                    
                    // æ›´æ–°é’±åŒ…çŠ¶æ€
                    await updateWalletStatus();
                    
                    // åŠ è½½å¸‚åœºæ•°æ®
                    loadMarketplace(1);
                    
                    // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
                    if (connectionStatus.textContent !== 'é’±åŒ…å·²è¿æ¥ï¼Œä½†éƒ¨åˆ†åˆçº¦åˆå§‹åŒ–å¤±è´¥') {
                        connectionStatus.textContent = 'é’±åŒ…å·²è¿æ¥';
                        connectionStatus.style.color = '#4CAF50';
                    }
                    connectWalletBtn.textContent = 'å·²è¿æ¥';
                    connectWalletBtn.disabled = true;
                    
                    console.log('é’±åŒ…è¿æ¥æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°');
                } catch (error) {
                    console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                    // é‡ç½®çŠ¶æ€
                    web3 = null;
                    nftTradingContract = null;
                    fiveBlessingsNFTContract = null;
                    accounts = [];
                    walletAddress.textContent = 'æœªè¿æ¥é’±åŒ…';
                    
                    // åˆ†æé”™è¯¯åŸå› 
                    let errorMessage = 'è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                    if (error.code === 4001) {
                        errorMessage = 'ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚';
                    } else if (error.message && error.message.includes('chainId')) {
                        errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
                    } else if (error.message && error.message.includes('contract')) {
                        errorMessage = 'åˆçº¦è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆçº¦åœ°å€';
                    }
                    
                    connectionStatus.textContent = errorMessage;
                    connectionStatus.style.color = '#f44336';
                    connectWalletBtn.textContent = 'è¿æ¥';
                    connectWalletBtn.disabled = false;
                }
            } else {
                alert('è¯·å®‰è£…MetaMaskç­‰Web3é’±åŒ…æ’ä»¶');
                // é‡ç½®çŠ¶æ€
                web3 = null;
                nftTradingContract = null;
                fiveBlessingsNFTContract = null;
                accounts = [];
                walletAddress.textContent = 'æœªè¿æ¥é’±åŒ…';
                connectionStatus.textContent = 'è¯·å®‰è£…Web3é’±åŒ…æ’ä»¶';
                connectionStatus.style.color = '#f44336';
                connectWalletBtn.textContent = 'è¿æ¥';
                connectWalletBtn.disabled = false;
            }
        }

        // æ›´æ–°é’±åŒ…çŠ¶æ€
        async function updateWalletStatus() {
            if (accounts && accounts.length > 0) {
                const address = accounts[0];
                const balance = await web3.eth.getBalance(address);
                const networkId = await web3.eth.getChainId();
                
                document.getElementById('walletAddress').textContent = address.substring(0, 4) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressDisplay').textContent = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('balance').textContent = (web3.utils.fromWei(balance, 'ether')).substring(0, 10) + ' BNB';
                
                let networkName = 'æœªçŸ¥ç½‘ç»œ';
                switch (networkId) {
                    case 1: networkName = 'ä»¥å¤ªåŠä¸»ç½‘'; break;
                    case 5: networkName = 'Goerliæµ‹è¯•ç½‘'; break;
                    case 1337: networkName = 'æœ¬åœ°å¼€å‘ç½‘'; break;
                    case 56: networkName = 'BSCä¸»ç½‘'; break;
                    case 97: networkName = 'BSCæµ‹è¯•ç½‘'; break;
                }
                document.getElementById('networkName').textContent = networkName;
                
                // å¯ç”¨æˆæƒæŒ‰é’®
                approveBtn.disabled = false;
                // æ›´æ–°æˆæƒçŠ¶æ€
                await updateApprovalStatus();
            }
        }
        
        // æ›´æ–°æˆæƒçŠ¶æ€
        async function updateApprovalStatus() {
            if (!accounts || accounts.length === 0 || !fiveBlessingsNFTContract) {
                return;
            }
            
            try {
                const isApproved = await checkApprovalForAll();
                if (isApproved) {
                    approveBtn.innerHTML = '<i class="fas fa-check mr-1"></i> å·²æˆæƒ';
                    approveBtn.classList.remove('btn-secondary');
                    approveBtn.classList.add('btn-primary');
                } else {
                    approveBtn.innerHTML = '<i class="fas fa-key mr-1"></i> æˆæƒNFTç³»åˆ—';
                    approveBtn.classList.remove('btn-primary');
                    approveBtn.classList.add('btn-secondary');
                }
            } catch (error) {
                console.error('æ›´æ–°æˆæƒçŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åˆ†é¡µçŠ¶æ€
        let marketplaceCurrentPage = 1;
        const marketplacePageSize = 10;
        let marketplaceTotalListings = [];
        let marketplaceCache = null; // ç¼“å­˜å¸‚åœºæ•°æ®
        let cacheTimestamp = 0; // ç¼“å­˜æ—¶é—´æˆ³
        const CACHE_DURATION = 30000; // ç¼“å­˜æŒç»­æ—¶é—´ï¼ˆ30ç§’ï¼‰

        // åŠ è½½å¸‚åœºæ•°æ®
        async function loadMarketplace(page = 1) {
            const marketplaceGrid = document.getElementById('marketplaceGrid');
            marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i><p class="text-gray-600">åŠ è½½å¸‚åœºæ•°æ®ä¸­...</p></div>';
            
            try {
                if (!nftTradingContract || !fiveBlessingsNFTContract) {
                    showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                    marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-wallet text-gray-400 mb-4"></i><p class="text-gray-600">è¯·è¿æ¥é’±åŒ…</p></div>';
                    return;
                }
                
                // æ£€æŸ¥ç¼“å­˜
                const now = Date.now();
                if (marketplaceCache && (now - cacheTimestamp) < CACHE_DURATION) {
                    console.log('ä½¿ç”¨ç¼“å­˜çš„å¸‚åœºæ•°æ®');
                    const cachedListings = marketplaceCache;
                    
                    if (cachedListings.length === 0) {
                        marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-shopping-cart text-4xl text-gray-400 mb-4"></i><p class="text-gray-600">å¸‚åœºæš‚æ— NFTä¸Šæ¶</p></div>';
                        return;
                    }
                    
                    // è®¡ç®—åˆ†é¡µ
                    const totalPages = Math.ceil(cachedListings.length / marketplacePageSize);
                    marketplaceCurrentPage = page;
                    
                    // è·å–å½“å‰é¡µæ•°æ®
                    const startIndex = (page - 1) * marketplacePageSize;
                    const endIndex = startIndex + marketplacePageSize;
                    const currentPageListings = cachedListings.slice(startIndex, endIndex);
                    
                    // ç”ŸæˆHTML
                    let html = '';
                    for (const listing of currentPageListings) {
                        html += `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-xl font-bold text-dark">${blessingTypes[listing.type]}</h3>
                                            <p class="text-gray-600">NFT #${listing.tokenId}</p>
                                        </div>
                                        <span class="bg-light text-primary px-3 py-1 rounded-full text-sm">${blessingTypes[listing.type]}</span>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <p class="text-gray-600">å–å®¶: ${listing.seller.substring(0, 6)}...${listing.seller.substring(listing.seller.length - 4)}</p>
                                    </div>
                                    
                                    <div class="flex justify-between items-center mb-4">
                                        <p class="text-gray-600">ä»·æ ¼</p>
                                        <p class="text-2xl font-bold text-primary">${listing.price} BNB</p>
                                    </div>
                                    
                                    <button class="buyBtn btn-primary w-full" data-tokenid="${listing.tokenId}" data-price="${listing.price}" data-seller="${listing.seller}" data-type="${listing.type}">
                                        <i class="fa fa-shopping-bag mr-2"></i>ç«‹å³è´­ä¹°
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    // æ·»åŠ åˆ†é¡µæ§ä»¶
                    html += `
                        <div class="col-span-full flex justify-center mt-8">
                            <nav class="flex items-center space-x-2">
                                <button ${page === 1 ? 'disabled' : ''} onclick="loadMarketplace(${page - 1})" class="px-4 py-2 rounded-md ${page === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-primary hover:bg-gray-100'}">
                                    <i class="fa fa-chevron-left"></i>
                                </button>
                                ${Array.from({length: totalPages}, (_, i) => i + 1).map(p => `
                                    <button onclick="loadMarketplace(${p})" class="px-4 py-2 rounded-md ${p === page ? 'bg-primary text-white' : 'bg-white text-primary hover:bg-gray-100'}">
                                        ${p}
                                    </button>
                                `).join('')}
                                <button ${page === totalPages ? 'disabled' : ''} onclick="loadMarketplace(${page + 1})" class="px-4 py-2 rounded-md ${page === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-primary hover:bg-gray-100'}">
                                    <i class="fa fa-chevron-right"></i>
                                </button>
                            </nav>
                        </div>
                    `;
                    
                    marketplaceGrid.innerHTML = html;
                    
                    // æ·»åŠ è´­ä¹°æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.buyBtn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tokenId = this.getAttribute('data-tokenid');
                    const price = this.getAttribute('data-price');
                    const seller = this.getAttribute('data-seller');
                    const type = this.getAttribute('data-type');
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±ä¸Šæ¶çš„NFT
                    if (accounts && accounts.length > 0 && seller.toLowerCase() === accounts[0].toLowerCase()) {
                        showMessage('ä¸èƒ½è´­ä¹°è‡ªå·±ä¸Šæ¶çš„NFT', 'error');
                        return;
                    }
                    
                    showBuyModal(parseInt(tokenId), price, seller, parseInt(type));
                });
            });
                    
                    return;
                }
                
                // ä»åˆçº¦ä¸­è·å–æ‰€æœ‰ä¸Šæ¶çš„NFT
                const listings = [];
                
                // ä¼˜åŒ–çš„éå†é€»è¾‘ï¼šé™åˆ¶æ£€æŸ¥çš„tokenIdèŒƒå›´ï¼Œå‡å°‘åˆçº¦è°ƒç”¨æ¬¡æ•°
                const maxTokenIdToCheck = 50; // æœ€å¤šæ£€æŸ¥50ä¸ªtokenIdï¼ŒåŠ å¿«åŠ è½½é€Ÿåº¦
                
                console.log('å¼€å§‹åŠ è½½å¸‚åœºæ•°æ®ï¼Œæœ€å¤šæ£€æŸ¥', maxTokenIdToCheck, 'ä¸ªtokenId');
                
                // æ˜¾ç¤ºåŠ è½½è¿›åº¦
                marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i><p class="text-gray-600">åŠ è½½å¸‚åœºæ•°æ®ä¸­...</p></div>';
                
                // ä½¿ç”¨å¹¶è¡Œè°ƒç”¨ä¼˜åŒ–åŠ è½½é€Ÿåº¦
                const promises = [];
                for (let tokenId = 1; tokenId <= maxTokenIdToCheck; tokenId++) {
                    promises.push(
                        (async (id) => {
                            try {
                                // ç¡®ä¿åˆçº¦å®ä¾‹å­˜åœ¨
                                if (!nftTradingContract || !fiveBlessingsNFTContract) {
                                    return null;
                                }
                                
                                const result = await nftTradingContract.methods.getListing(id).call();
                                const listing = result[0];
                                if (listing.isActive) {
                                    // è·å–NFTç±»å‹
                                    const type = await fiveBlessingsNFTContract.methods.tokenType(id).call();
                                    const price = web3.utils.fromWei(listing.price, 'ether');
                                    
                                    return {
                                        tokenId: id,
                                        price: price,
                                        priceWei: listing.price, // ç”¨äºæ’åº
                                        seller: listing.seller,
                                        type: type
                                    };
                                }
                                return null;
                            } catch (e) {
                                // å¿½ç•¥ä¸å­˜åœ¨çš„token
                                return null;
                            }
                        })(tokenId)
                    );
                }
                
                // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
                const results = await Promise.all(promises);
                
                // å¤„ç†ç»“æœ
                for (const result of results) {
                    if (result) {
                        listings.push(result);
                        console.log('å‘ç°æ´»è·ƒä¸Šæ¶:', result.tokenId);
                    }
                }
                
                console.log('å¸‚åœºæ•°æ®åŠ è½½å®Œæˆï¼Œæ‰¾åˆ°', listings.length, 'ä¸ªä¸Šæ¶NFT');
                
                // æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜æ’åº
                listings.sort((a, b) => parseFloat(a.priceWei) - parseFloat(b.priceWei));
                marketplaceTotalListings = listings;
                
                // æ›´æ–°ç¼“å­˜
                marketplaceCache = listings;
                cacheTimestamp = Date.now();
                
                // æ˜¾ç¤ºç»“æœ
                displayMarketplaceListings(listings, page);
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥:', error);
                marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-exclamation-circle text-red-500 mb-4"></i><p class="text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p></div>';
            }
        }

        // æ˜¾ç¤ºå¸‚åœºåˆ—è¡¨
        function displayMarketplaceListings(listings, page) {
            const marketplaceGrid = document.getElementById('marketplaceGrid');
            console.log('å¼€å§‹æ˜¾ç¤ºå¸‚åœºåˆ—è¡¨ï¼Œæ•°æ®æ•°é‡:', listings.length, 'é¡µç :', page);
            
            if (listings.length === 0) {
                console.log('å¸‚åœºæš‚æ— NFTä¸Šæ¶');
                marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-shopping-cart text-4xl text-gray-400 mb-4"></i><p class="text-gray-600">å¸‚åœºæš‚æ— NFTä¸Šæ¶</p></div>';
                return;
            }
            
            // è®¡ç®—åˆ†é¡µ
            const totalPages = Math.ceil(listings.length / marketplacePageSize);
            marketplaceCurrentPage = page;
            console.log('è®¡ç®—åˆ†é¡µï¼Œæ€»é¡µæ•°:', totalPages);
            
            // è·å–å½“å‰é¡µæ•°æ®
            const startIndex = (page - 1) * marketplacePageSize;
            const endIndex = startIndex + marketplacePageSize;
            const currentPageListings = listings.slice(startIndex, endIndex);
            console.log('å½“å‰é¡µæ•°æ®èŒƒå›´:', startIndex, '-', endIndex, 'æ•°æ®æ•°é‡:', currentPageListings.length);
            
            // ç”ŸæˆHTML
            let html = '';
            for (const listing of currentPageListings) {
                html += `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-dark">${blessingTypes[listing.type]}</h3>
                                    <p class="text-gray-600">NFT #${listing.tokenId}</p>
                                </div>
                                <span class="bg-light text-primary px-3 py-1 rounded-full text-sm">${blessingTypes[listing.type]}</span>
                            </div>
                            
                            <div class="mb-4">
                                <p class="text-gray-600">å–å®¶: ${listing.seller.substring(0, 6)}...${listing.seller.substring(listing.seller.length - 4)}</p>
                            </div>
                            
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-600">ä»·æ ¼</p>
                                <p class="text-2xl font-bold text-primary">${listing.price} BNB</p>
                            </div>
                            
                            <button class="buyBtn btn-primary w-full" data-tokenid="${listing.tokenId}" data-price="${listing.price}" data-seller="${listing.seller}" data-type="${listing.type}">
                                <i class="fa fa-shopping-bag mr-2"></i>ç«‹å³è´­ä¹°
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // æ·»åŠ åˆ†é¡µæ§ä»¶
            html += `
                <div class="col-span-full flex justify-center mt-8">
                    <nav class="flex items-center space-x-2">
                        <button ${page === 1 ? 'disabled' : ''} onclick="loadMarketplace(${page - 1})" class="px-4 py-2 rounded-md ${page === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-primary hover:bg-gray-100'}">
                            <i class="fa fa-chevron-left"></i>
                        </button>
                        ${Array.from({length: totalPages}, (_, i) => i + 1).map(p => `
                            <button onclick="loadMarketplace(${p})" class="px-4 py-2 rounded-md ${p === page ? 'bg-primary text-white' : 'bg-white text-primary hover:bg-gray-100'}">
                                ${p}
                            </button>
                        `).join('')}
                        <button ${page === totalPages ? 'disabled' : ''} onclick="loadMarketplace(${page + 1})" class="px-4 py-2 rounded-md ${page === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-primary hover:bg-gray-100'}">
                            <i class="fa fa-chevron-right"></i>
                        </button>
                    </nav>
                </div>
            `;
            
            // ç«‹å³æ›´æ–°DOM
            console.log('æ›´æ–°DOMï¼Œæ˜¾ç¤ºå¸‚åœºåˆ—è¡¨');
            marketplaceGrid.innerHTML = html;
            
            // æ·»åŠ è´­ä¹°æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.buyBtn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tokenId = this.getAttribute('data-tokenid');
                    const price = this.getAttribute('data-price');
                    const seller = this.getAttribute('data-seller');
                    const type = this.getAttribute('data-type');
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±ä¸Šæ¶çš„NFT
                    if (accounts && accounts.length > 0 && seller.toLowerCase() === accounts[0].toLowerCase()) {
                        showMessage('ä¸èƒ½è´­ä¹°è‡ªå·±ä¸Šæ¶çš„NFT', 'error');
                        return;
                    }
                    
                    showBuyModal(parseInt(tokenId), price, seller, parseInt(type));
                });
            });
        }

        // åŠ è½½å¸‚åœºæ•°æ® (ä¿®æ”¹åçš„ç‰ˆæœ¬)
        async function loadMarketplace(page = 1) {
            const marketplaceGrid = document.getElementById('marketplaceGrid');
            
            // ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i><p class="text-gray-600">åŠ è½½å¸‚åœºæ•°æ®ä¸­...</p></div>';
            
            try {
                console.log('å¼€å§‹åŠ è½½å¸‚åœºæ•°æ®ï¼Œé¡µç :', page);
                
                // æ£€æŸ¥åˆçº¦å®ä¾‹
                if (!nftTradingContract || !fiveBlessingsNFTContract) {
                    console.log('åˆçº¦å®ä¾‹ä¸å­˜åœ¨');
                    showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                    marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-wallet text-gray-400 mb-4"></i><p class="text-gray-600">è¯·è¿æ¥é’±åŒ…</p></div>';
                    return;
                }
                
                // æ£€æŸ¥ç¼“å­˜
                const now = Date.now();
                if (marketplaceCache && (now - cacheTimestamp) < CACHE_DURATION) {
                    console.log('ä½¿ç”¨ç¼“å­˜çš„å¸‚åœºæ•°æ®ï¼Œç¼“å­˜æ—¶é—´:', cacheTimestamp);
                    displayMarketplaceListings(marketplaceCache, page);
                    return;
                }
                
                console.log('ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹ä»åˆçº¦åŠ è½½æ•°æ®');
                
                // ä»åˆçº¦ä¸­è·å–æ‰€æœ‰ä¸Šæ¶çš„NFT
                const listings = [];
                
                // è¿›ä¸€æ­¥å‡å°‘æ£€æŸ¥çš„tokenIdèŒƒå›´ï¼ŒåŠ å¿«åŠ è½½é€Ÿåº¦
                const maxTokenIdToCheck = 30; // å‡å°‘åˆ°30ä¸ªtokenIdï¼Œæ›´å¿«åŠ è½½
                
                console.log('å¼€å§‹æ£€æŸ¥tokenIdï¼Œæœ€å¤šæ£€æŸ¥:', maxTokenIdToCheck);
                
                // ä½¿ç”¨å¹¶è¡Œè°ƒç”¨ä¼˜åŒ–åŠ è½½é€Ÿåº¦
                const promises = [];
                for (let tokenId = 1; tokenId <= maxTokenIdToCheck; tokenId++) {
                    promises.push(
                        (async (id) => {
                            try {
                                // ç¡®ä¿åˆçº¦å®ä¾‹å­˜åœ¨
                                if (!nftTradingContract || !fiveBlessingsNFTContract) {
                                    return null;
                                }
                                
                                const result = await nftTradingContract.methods.getListing(id).call();
                                const listing = result[0];
                                if (listing.isActive) {
                                    // è·å–NFTç±»å‹
                                    const type = await fiveBlessingsNFTContract.methods.tokenType(id).call();
                                    const price = web3.utils.fromWei(listing.price, 'ether');
                                    
                                    return {
                                        tokenId: id,
                                        price: price,
                                        priceWei: listing.price, // ç”¨äºæ’åº
                                        seller: listing.seller,
                                        type: type
                                    };
                                }
                                return null;
                            } catch (e) {
                                // å¿½ç•¥ä¸å­˜åœ¨çš„token
                                return null;
                            }
                        })(tokenId)
                    );
                }
                
                // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
                const results = await Promise.all(promises);
                console.log('å¹¶è¡Œè°ƒç”¨å®Œæˆï¼Œç»“æœæ•°é‡:', results.length);
                
                // å¤„ç†ç»“æœ
                for (const result of results) {
                    if (result) {
                        listings.push(result);
                        console.log('å‘ç°æ´»è·ƒä¸Šæ¶:', result.tokenId);
                    }
                }
                
                console.log('å¸‚åœºæ•°æ®åŠ è½½å®Œæˆï¼Œæ‰¾åˆ°', listings.length, 'ä¸ªä¸Šæ¶NFT');
                
                // æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜æ’åº
                listings.sort((a, b) => parseFloat(a.priceWei) - parseFloat(b.priceWei));
                marketplaceTotalListings = listings;
                
                // æ›´æ–°ç¼“å­˜
                marketplaceCache = listings;
                cacheTimestamp = now;
                console.log('ç¼“å­˜å·²æ›´æ–°ï¼Œæ—¶é—´æˆ³:', cacheTimestamp);
                
                // æ˜¾ç¤ºç»“æœ
                displayMarketplaceListings(listings, page);
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥:', error);
                marketplaceGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-exclamation-circle text-red-500 mb-4"></i><p class="text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p></div>';
            }
        }

        // æˆ‘çš„ä¸Šæ¶åˆ†é¡µçŠ¶æ€
        let myListingsCurrentPage = 1;
        const myListingsPageSize = 10;
        let myListingsTotalListings = [];

        // åŠ è½½æˆ‘çš„ä¸Šæ¶
        async function loadMyListings(page = 1) {
            const myListingsGrid = document.getElementById('myListingsGrid');
            myListingsGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i><p class="text-gray-600">åŠ è½½æˆ‘çš„ä¸Šæ¶æ•°æ®ä¸­...</p></div>';
            
            try {
                if (!accounts || accounts.length === 0) {
                    myListingsGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-wallet text-gray-400 mb-4"></i><p class="text-gray-600">è¯·è¿æ¥é’±åŒ…</p></div>';
                    return;
                }
                
                if (!nftTradingContract || !fiveBlessingsNFTContract) {
                    showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                    myListingsGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-wallet text-gray-400 mb-4"></i><p class="text-gray-600">è¯·è¿æ¥é’±åŒ…</p></div>';
                    return;
                }
                
                // ä»åˆçº¦ä¸­è·å–ç”¨æˆ·ä¸Šæ¶çš„NFT
                const userTokens = await nftTradingContract.methods.getUserListedTokens(accounts[0]).call();
                const activeListings = [];
                
                for (const tokenId of userTokens) {
                    try {
                        // ç›´æ¥è°ƒç”¨ï¼Œä¸ä½¿ç”¨è§£æ„èµ‹å€¼
                        const result = await nftTradingContract.methods.getListing(tokenId).call();
                        const listing = result[0];
                        if (listing.isActive) {
                            const type = await fiveBlessingsNFTContract.methods.tokenType(tokenId).call();
                            const price = web3.utils.fromWei(listing.price, 'ether');
                            
                            activeListings.push({
                                tokenId: tokenId,
                                price: price,
                                type: type
                            });
                        }
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯
                        console.log('å¿½ç•¥tokenId', tokenId, 'é”™è¯¯:', e.message);
                    }
                }
                
                console.log('æˆ‘çš„ä¸Šæ¶æ•°æ®åŠ è½½å®Œæˆï¼Œæ‰¾åˆ°', activeListings.length, 'ä¸ªä¸Šæ¶NFT');
                myListingsTotalListings = activeListings;
                
                if (activeListings.length === 0) {
                    myListingsGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-upload text-gray-400 mb-4"></i><p class="text-gray-600">ä½ è¿˜æ²¡æœ‰ä¸Šæ¶ä»»ä½•NFT</p></div>';
                    return;
                }
                
                // è®¡ç®—åˆ†é¡µ
                const totalPages = Math.ceil(activeListings.length / myListingsPageSize);
                myListingsCurrentPage = page;
                
                // è·å–å½“å‰é¡µæ•°æ®
                const startIndex = (page - 1) * myListingsPageSize;
                const endIndex = startIndex + myListingsPageSize;
                const currentPageListings = activeListings.slice(startIndex, endIndex);
                
                let html = '';
                for (const listing of currentPageListings) {
                    html += `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                            <div class="p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-dark">${blessingTypes[listing.type]}</h3>
                                        <p class="text-gray-600">NFT #${listing.tokenId}</p>
                                    </div>
                                    <span class="bg-light text-primary px-3 py-1 rounded-full text-sm">${blessingTypes[listing.type]}</span>
                                </div>
                                
                                <div class="flex justify-between items-center mb-4">
                                    <p class="text-gray-600">ä»·æ ¼</p>
                                    <p class="text-2xl font-bold text-primary">${listing.price} BNB</p>
                                </div>
                                
                                <button class="unlistBtn btn-danger w-full" data-tokenid="${listing.tokenId}">
                                    <i class="fa fa-times mr-2"></i>ä¸‹æ¶NFT
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // æ·»åŠ åˆ†é¡µæ§ä»¶
                // å³ä½¿åªæœ‰ä¸€é¡µä¹Ÿæ˜¾ç¤ºåˆ†é¡µæ§ä»¶ï¼Œè®©ç”¨æˆ·çŸ¥é“å½“å‰çš„åˆ†é¡µçŠ¶æ€
                html += `
                    <div class="col-span-full flex justify-center mt-8">
                        <nav class="flex items-center space-x-2">
                            <button ${page === 1 ? 'disabled' : ''} onclick="loadMyListings(${page - 1})" class="px-4 py-2 rounded-md ${page === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-primary hover:bg-gray-100'}">
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            ${Array.from({length: totalPages}, (_, i) => i + 1).map(p => `
                                <button onclick="loadMyListings(${p})" class="px-4 py-2 rounded-md ${p === page ? 'bg-primary text-white' : 'bg-white text-primary hover:bg-gray-100'}">
                                    ${p}
                                </button>
                            `).join('')}
                            <button ${page === totalPages ? 'disabled' : ''} onclick="loadMyListings(${page + 1})" class="px-4 py-2 rounded-md ${page === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-primary hover:bg-gray-100'}">
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </nav>
                    </div>
                `;
                
                myListingsGrid.innerHTML = html;
                
                // æ·»åŠ ä¸‹æ¶æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.unlistBtn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const tokenId = this.getAttribute('data-tokenid');
                        await unlistNFT(parseInt(tokenId));
                    });
                });
            } catch (error) {
                console.error('åŠ è½½æˆ‘çš„ä¸Šæ¶æ•°æ®å¤±è´¥:', error);
                myListingsGrid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa fa-exclamation-circle text-red-500 mb-4"></i><p class="text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p></div>';
            }
        }

        // æ˜¾ç¤ºè´­ä¹°æ¨¡æ€æ¡†
        function showBuyModal(tokenId, price, seller, type) {
            currentTokenIdToBuy = tokenId;
            const fee = (parseFloat(price) * 0.05).toFixed(4);
            const total = (parseFloat(price) + parseFloat(fee)).toFixed(4);
            
            document.getElementById('modalTokenId').textContent = tokenId;
            document.getElementById('modalTokenType').textContent = blessingTypes[type];
            document.getElementById('modalSeller').textContent = seller.substring(0, 6) + '...' + seller.substring(seller.length - 4);
            document.getElementById('modalPrice').textContent = price;
            document.getElementById('modalFee').textContent = fee;
            document.getElementById('modalTotal').textContent = total;
            
            // ç¡®ä¿è´§å¸å•ä½ä¸ºBNB
            document.getElementById('balance').textContent = document.getElementById('balance').textContent.replace('ETH', 'BNB');
            
            document.getElementById('buyModal').classList.remove('hidden');
        }

        // ä¸Šæ¶NFT
        async function listNFT(tokenId, price) {
            try {
                if (!accounts || accounts.length === 0) {
                    showMessage('è¯·è¿æ¥é’±åŒ…', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²æˆæƒæ•´ä¸ªç³»åˆ—
                const isApproved = await checkApprovalForAll();
                if (!isApproved) {
                    // æœªæˆæƒï¼Œå…ˆæˆæƒæ•´ä¸ªç³»åˆ—
                    showMessage('æ­£åœ¨æˆæƒæ•´ä¸ªNFTç³»åˆ—ç»™äº¤æ˜“åˆçº¦...', 'info');
                    await approveForAll();
                }
                
                const priceWei = web3.utils.toWei(price.toString(), 'ether');
                
                const tx = await nftTradingContract.methods.listNFT(tokenId, priceWei).send({
                    from: accounts[0]
                });
                
                showMessage('NFTä¸Šæ¶æˆåŠŸï¼', 'success');
                document.getElementById('listForm').reset();
            } catch (error) {
                console.error('ä¸Šæ¶NFTå¤±è´¥:', error);
                showMessage('ä¸Šæ¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥æ˜¯å¦å·²æˆæƒæ•´ä¸ªNFTç³»åˆ—ç»™äº¤æ˜“åˆçº¦
        async function checkApprovalForAll() {
            try {
                const isApproved = await fiveBlessingsNFTContract.methods.isApprovedForAll(accounts[0], NFTTradingAddress).call();
                return isApproved;
            } catch (error) {
                console.error('æ£€æŸ¥æˆæƒå¤±è´¥:', error);
                return false;
            }
        }

        // æˆæƒæ•´ä¸ªNFTç³»åˆ—ç»™äº¤æ˜“åˆçº¦
        async function approveForAll() {
            try {
                const tx = await fiveBlessingsNFTContract.methods.setApprovalForAll(NFTTradingAddress, true).send({
                    from: accounts[0]
                });
                showMessage('NFTç³»åˆ—æˆæƒæˆåŠŸï¼', 'success');
                return true;
            } catch (error) {
                console.error('æˆæƒNFTç³»åˆ—å¤±è´¥:', error);
                showMessage('æˆæƒå¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // ä¸‹æ¶NFT
        async function unlistNFT(tokenId) {
            try {
                if (!accounts || accounts.length === 0) {
                    showMessage('è¯·è¿æ¥é’±åŒ…', 'error');
                    return;
                }
                
                const tx = await nftTradingContract.methods.unlistNFT(tokenId).send({
                    from: accounts[0]
                });
                
                showMessage('NFTä¸‹æ¶æˆåŠŸï¼', 'success');
                loadMyListings(myListingsCurrentPage); // åˆ·æ–°æˆ‘çš„ä¸Šæ¶åˆ—è¡¨
                loadMarketplace(1); // åˆ·æ–°å¸‚åœºåˆ—è¡¨
            } catch (error) {
                console.error('ä¸‹æ¶NFTå¤±è´¥:', error);
                showMessage('ä¸‹æ¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è´­ä¹°NFT
        async function buyNFT(tokenId, price) {
            try {
                if (!accounts || accounts.length === 0) {
                    showMessage('è¯·è¿æ¥é’±åŒ…', 'error');
                    return;
                }
                
                if (!nftTradingContract) {
                    showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                    return;
                }
                
                // éªŒè¯ä»·æ ¼
                if (!price || parseFloat(price) <= 0) {
                    showMessage('ä»·æ ¼å¿…é¡»å¤§äº0', 'error');
                    return;
                }
                
                // å°†BNBä»·æ ¼è½¬æ¢ä¸ºwei
                const priceWei = web3.utils.toWei(price.toString(), 'ether');
                console.log('è´­ä¹°NFT:', tokenId, 'ä»·æ ¼:', price, 'wei:', priceWei);
                
                showMessage('æ­£åœ¨å¤„ç†è´­ä¹°äº¤æ˜“...', 'info');
                
                const tx = await nftTradingContract.methods.buyNFT(tokenId).send({
                    from: accounts[0],
                    value: priceWei
                });
                
                showMessage('NFTè´­ä¹°æˆåŠŸï¼', 'success');
                document.getElementById('buyModal').classList.add('hidden');
                loadMarketplace(1); // åˆ·æ–°å¸‚åœºåˆ—è¡¨
                loadMyListings(1); // åˆ·æ–°æˆ‘çš„ä¸Šæ¶åˆ—è¡¨
            } catch (error) {
                console.error('è´­ä¹°NFTå¤±è´¥:', error);
                showMessage('è´­ä¹°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥NFT
        async function checkNFT(tokenId) {
            try {
                const owner = await fiveBlessingsNFTContract.methods.ownerOf(tokenId).call();
                const type = await fiveBlessingsNFTContract.methods.tokenType(tokenId).call();
                
                if (owner.toLowerCase() !== accounts[0].toLowerCase()) {
                    showMessage('ä½ ä¸æ˜¯è¯¥NFTçš„æ‰€æœ‰è€…', 'error');
                    return false;
                }
                
                showMessage(`NFTæ£€æŸ¥æˆåŠŸï¼ç±»å‹ï¼š${blessingTypes[type]}`, 'success');
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥NFTå¤±è´¥:', error);
                showMessage('NFTä¸å­˜åœ¨æˆ–æ£€æŸ¥å¤±è´¥', 'error');
                return false;
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const message = document.getElementById('message');
            message.textContent = text;
            
            // è®¾ç½®æ ·å¼
            message.className = 'fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-y-0 opacity-100';
            
            if (type === 'success') {
                message.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                message.classList.add('bg-red-500', 'text-white');
            } else {
                message.classList.add('bg-blue-500', 'text-white');
            }
            
            // 3ç§’åéšè—
            setTimeout(() => {
                message.classList.add('translate-y-[-100px]', 'opacity-0');
                setTimeout(() => {
                    message.classList.add('hidden');
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>